{% extends "base.html" %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>AI Business Advisor</h4>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="question">Ask a question about your business:</label>
                        <textarea class="form-control" id="question" rows="4" placeholder="e.g., 'Should I reorder from Supplier X?' or 'What are my top-selling items?'"></textarea>
                    </div>
                    <button class="btn btn-primary" id="ask-btn">Ask AI</button>
                    <div id="result-area" class="mt-4 p-3 bg-light rounded" style="min-height: 100px; display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ g.nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    const askBtn = document.getElementById('ask-btn');
    const question = document.getElementById('question');
    const resultArea = document.getElementById('result-area');
    let pollInterval = null;

    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    function stopPolling(message) {
        if (pollInterval) clearInterval(pollInterval);
        resultArea.style.display = 'block';
        resultArea.innerHTML = message;
        askBtn.disabled = false;
        askBtn.innerText = 'Ask AI';
    }

    async function checkStatus(taskId) {
        try {
            const res = await fetch(`/ai/status/${taskId}`);
            const data = await res.json();
            if (data.status === 'completed') {
                stopPolling(data.answer);
            } else if (data.status === 'failed') {
                stopPolling('❌ AI analysis failed. Please try again.');
            }
        } catch (e) {
            console.error('Poll error:', e);
        }
    }

    askBtn.addEventListener('click', async function() {
        const q = question.value.trim();
        if (!q) {
            alert('Please enter a question.');
            return;
        }

        askBtn.disabled = true;
        askBtn.innerText = 'Processing...';
        resultArea.style.display = 'block';
        resultArea.innerHTML = '<i>AI is thinking...</i>';

        try {
            const response = await fetch('/ai/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ question: q })
            });

            if (response.status === 429) {
                const data = await response.json();
                stopPolling('⏳ ' + (data.message || 'Rate limit hit.'));
                return;
            }

            const data = await response.json();
            if (data.status === 'queued') {
                pollInterval = setInterval(() => checkStatus(data.task_id), 2000);
            } else {
                stopPolling('Unexpected response.');
            }
        } catch (e) {
            stopPolling('❌ Network error. Please try again.');
        }
    });
});
</script>
{% endblock %}