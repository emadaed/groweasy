{% extends "base.html" %}

{% block title %}Create Purchase Order{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center mb-4">Create Purchase Order</h2>

    <form method="POST" action="{{ url_for('purchases.create_po_process') }}" id="poForm">
        <div class="row">
            <div class="col-md-6">
                <h5>Supplier</h5>
                <select name="supplier_id" id="supplier_select" class="form-select mb-2" required>
                    <option value="">-- Select Registered Vendor --</option>
                    {% for s in suppliers %}
                    <option value="{{ s.id }}" 
                            data-name="{{ s.name }}"
                            data-email="{{ s.email or '' }}"
                            data-phone="{{ s.phone or '' }}">
                        {{ s.name }}
                    </option>
                    {% endfor %}
                </select>                
                <input type="hidden" name="supplier_name" id="hidden_supplier_name">
                <input type="hidden" name="supplier_email" id="hidden_supplier_email">
                <input type="hidden" name="supplier_phone" id="hidden_supplier_phone">
                                
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#supplierModal">
                    + Add New Supplier
                </button>
            </div>            
            <div class="col-md-6">
                <h5>PO Details</h5>
                <input type="date" class="form-control mb-3" name="po_date" value="{{ today }}" required>
                <input type="date" class="form-control mb-3" name="delivery_date">
                <select class="form-select mb-3" name="delivery_method">
                    <option>Pickup</option>
                    <option>Courier</option>
                    <option>Supplier Delivery</option>
                </select>
            </div>
        </div>
        
        <hr>

        <h5>Items</h5>
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#inventoryModal">
            Add from Inventory
        </button>

        <table class="table" id="itemsTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <div class="text-center">
            <button type="submit" class="btn btn-success btn-lg">Create PO</button>
        </div>
    </form>
</div>

<div class="modal fade" id="inventoryModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Add from Inventory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Name</th>
                            <th>Stock</th>
                            <th>Cost Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inventory_items %}
                        <tr>
                            <td><input type="checkbox" class="item-check" data-id="{{ item.id }}" data-name="{{ item.name }}" data-price="{{ item.cost_price }}"></td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.current_stock }}</td>
                            <td>{{ item.cost_price }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="addInventoryItems">Add Selected</button>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.querySelector('#itemsTable tbody');
    const supplierSelect = document.getElementById('supplier_select');
    const hiddenNameInput = document.getElementById('hidden_supplier_name');

    // 1. SAFE MODAL HANDLING (Fixes the "Stuck" Issue)
    function hideModal(modalId) {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            // Try to get existing instance, otherwise create one to close it
            let modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (!modalInstance) {
                modalInstance = new bootstrap.Modal(modalElement);
            }
            modalInstance.hide();
            
            // Cleanup: Manually remove backdrops if Bootstrap fails to
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(b => b.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    }

    // 2. CSP-COMPLIANT SUPPLIER SYNC
    if (supplierSelect) {
        supplierSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                document.getElementById('hidden_supplier_name').value = selectedOption.getAttribute('data-name') || "";
                document.getElementById('hidden_supplier_email').value = selectedOption.getAttribute('data-email') || "";
                document.getElementById('hidden_supplier_phone').value = selectedOption.getAttribute('data-phone') || "";
            }
        });

    // 3. INVENTORY ITEM ADDITION
    document.getElementById('addInventoryItems').addEventListener('click', function() {
        const checkedItems = document.querySelectorAll('.item-check:checked');
        
        checkedItems.forEach(cb => {
            const id = cb.dataset.id;
            const name = cb.dataset.name;
            const price = cb.dataset.price;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="hidden" name="item_id[]" value="${id}">
                    ${name}
                </td>
                <td><input type="number" name="item_qty[]" value="1" min="1" class="form-control"></td>
                <td><input type="number" name="item_price[]" value="${price}" step="0.01" class="form-control"></td>
                <td class="total">${parseFloat(price).toFixed(2)}</td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
            `;
            tbody.appendChild(row);
            cb.checked = false; // Uncheck for next time
        });

        // Use the safe hide function
        hideModal('inventoryModal');
    });

    // 4. DYNAMIC CALCULATION
    tbody.addEventListener('input', function(e) {
        if (e.target.name === 'item_qty[]' || e.target.name === 'item_price[]') {
            const row = e.target.closest('tr');
            const qty = parseFloat(row.querySelector('[name="item_qty[]"]').value) || 0;
            const price = parseFloat(row.querySelector('[name="item_price[]"]').value) || 0;
            row.querySelector('.total').textContent = (qty * price).toFixed(2);
        }
    });

    tbody.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-row')) {
            e.target.closest('tr').remove();
        }
    });
});
</script>
{% endblock %}

